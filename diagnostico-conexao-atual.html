<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Conex√£o ERP - Outubro 2025</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .status-box {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-ok { border-left: 5px solid #4CAF50; }
        .status-error { border-left: 5px solid #f44336; }
        .status-warning { border-left: 5px solid #ff9800; }
        .log-area {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #1976D2; }
        .btn-success { background: #4CAF50; }
        .btn-danger { background: #f44336; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .metric {
            text-align: center;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1976D2;
        }
    </style>
</head>
<body>
    <h1>üîß Diagn√≥stico Urgente - Conex√£o ERP</h1>
    <p><strong>Data/Hora:</strong> <span id="datetime"></span></p>

    <div class="status-box status-warning">
        <h3>‚ö†Ô∏è Problema Detectado</h3>
        <p>Falha na conex√£o com ERP detectada. Iniciando diagn√≥stico completo...</p>
    </div>

    <div class="metrics">
        <div class="metric">
            <div class="metric-value" id="status">üîç</div>
            <div>Status ERP</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="response-time">--</div>
            <div>Tempo (ms)</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="products-count">--</div>
            <div>Produtos</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="network-status">üì°</div>
            <div>Internet</div>
        </div>
    </div>

    <div class="status-box">
        <h3>üöÄ Testes Autom√°ticos</h3>
        <button class="btn" onclick="runCompleteTest()">Executar Diagn√≥stico</button>
        <button class="btn btn-success" onclick="testDirectAPI()">Teste Direto API</button>
        <button class="btn btn-danger" onclick="exportErrorLog()">Exportar Logs</button>
    </div>

    <div class="log-area" id="diagnostic-log">
        [Sistema iniciado] Aguardando in√≠cio do diagn√≥stico...
    </div>

    <div class="status-box" id="results-area" style="display: none;">
        <h3>üìä Resultados</h3>
        <div id="test-results"></div>
    </div>

    <script>
        // Configura√ß√£o da API - mesma do sistema principal
        const API_CONFIG = {
            BASE_URL: 'https://studio--firebase-explorer-7hc2p.us-central1.hosted.app',
            ENDPOINTS: {
                PRODUCTS: '/api/products',
                CONTACT: '/api/contact',
                ORDERS: '/api/orders'
            },
            TIMEOUT: 10000
        };

        let diagnosticLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            diagnosticLog.push({ timestamp, message, type });
            
            const logArea = document.getElementById('diagnostic-log');
            logArea.innerHTML += logEntry + '\n';
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(logEntry);
        }

        function updateMetric(id, value) {
            document.getElementById(id).textContent = value;
        }

        function updateDateTime() {
            document.getElementById('datetime').textContent = new Date().toLocaleString('pt-BR');
        }

        async function testNetworkConnection() {
            log('üåê Testando conex√£o com internet...', 'info');
            
            try {
                const response = await fetch('https://www.google.com/favicon.ico', { 
                    method: 'HEAD', 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                updateMetric('network-status', '‚úÖ OK');
                log('‚úÖ Conex√£o com internet OK', 'success');
                return true;
            } catch (error) {
                updateMetric('network-status', '‚ùå ERRO');
                log('‚ùå Sem conex√£o com internet: ' + error.message, 'error');
                return false;
            }
        }

        async function testDirectAPI() {
            log('üîç Testando conex√£o direta com API ERP...', 'info');
            const startTime = Date.now();
            
            try {
                const url = API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.PRODUCTS;
                log(`üì° Testando URL: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    cache: 'no-cache'
                });

                const responseTime = Date.now() - startTime;
                updateMetric('response-time', responseTime);

                log(`üìä Resposta recebida: ${response.status} ${response.statusText}`, 'info');
                log(`‚è±Ô∏è Tempo de resposta: ${responseTime}ms`, 'info');

                if (response.ok) {
                    const data = await response.json();
                    const productCount = data.products ? data.products.length : 0;
                    
                    updateMetric('status', '‚úÖ OK');
                    updateMetric('products-count', productCount);
                    
                    log(`‚úÖ API respondeu corretamente!`, 'success');
                    log(`üì¶ Produtos encontrados: ${productCount}`, 'success');
                    log(`üìã Primeira amostra: ${data.products ? JSON.stringify(data.products[0], null, 2) : 'N/A'}`, 'info');
                    
                    return { success: true, data, responseTime, productCount };
                } else {
                    updateMetric('status', '‚ùå ERRO');
                    log(`‚ùå Erro na API: ${response.status} - ${response.statusText}`, 'error');
                    
                    const errorText = await response.text();
                    log(`üìã Detalhes do erro: ${errorText}`, 'error');
                    
                    return { success: false, error: response.statusText, responseTime };
                }
            } catch (error) {
                const responseTime = Date.now() - startTime;
                updateMetric('response-time', responseTime);
                updateMetric('status', 'üí• FALHA');
                
                log(`üí• Falha na conex√£o: ${error.message}`, 'error');
                log(`üîç Tipo do erro: ${error.name}`, 'error');
                log(`üìã Stack trace: ${error.stack}`, 'error');
                
                // Teste de DNS
                if (error.message.includes('Failed to fetch')) {
                    log('üîç Poss√≠vel problema de DNS ou firewall', 'warning');
                    log('üí° Tentando ping alternativo...', 'info');
                    
                    try {
                        const pingResponse = await fetch('https://httpbin.org/get', { method: 'HEAD', mode: 'no-cors' });
                        log('‚úÖ Internet funciona - problema espec√≠fico com a API', 'warning');
                    } catch (pingError) {
                        log('‚ùå Problema geral de conectividade', 'error');
                    }
                }
                
                return { success: false, error: error.message, responseTime };
            }
        }

        async function runCompleteTest() {
            log('üöÄ Iniciando diagn√≥stico completo...', 'info');
            log('==========================================', 'info');
            
            // Reset metrics
            updateMetric('status', 'üîç');
            updateMetric('response-time', '--');
            updateMetric('products-count', '--');
            updateMetric('network-status', 'üîç');

            // Teste 1: Conectividade geral
            const internetOK = await testNetworkConnection();
            
            // Teste 2: API direta
            const apiResult = await testDirectAPI();
            
            // Teste 3: Resumo
            log('==========================================', 'info');
            log('üìä RESUMO DO DIAGN√ìSTICO:', 'info');
            log(`üåê Internet: ${internetOK ? 'OK' : 'ERRO'}`, internetOK ? 'success' : 'error');
            log(`üì° API ERP: ${apiResult.success ? 'OK' : 'ERRO'}`, apiResult.success ? 'success' : 'error');
            
            if (apiResult.success) {
                log(`‚è±Ô∏è Tempo: ${apiResult.responseTime}ms`, 'success');
                log(`üì¶ Produtos: ${apiResult.productCount}`, 'success');
                log('‚úÖ SISTEMA FUNCIONANDO NORMALMENTE', 'success');
            } else {
                log(`‚ùå Erro: ${apiResult.error}`, 'error');
                log('üîß REQUER INTERVEN√á√ÉO T√âCNICA', 'error');
            }
            
            log('==========================================', 'info');
            
            // Mostrar √°rea de resultados
            document.getElementById('results-area').style.display = 'block';
            document.getElementById('test-results').innerHTML = `
                <div class="status-box ${apiResult.success ? 'status-ok' : 'status-error'}">
                    <h4>${apiResult.success ? '‚úÖ Sistema Operacional' : '‚ùå Sistema Com Problemas'}</h4>
                    <p><strong>Status:</strong> ${apiResult.success ? 'OK' : 'ERRO'}</p>
                    <p><strong>Tempo:</strong> ${apiResult.responseTime || '--'}ms</p>
                    <p><strong>Produtos:</strong> ${apiResult.productCount || 0}</p>
                    ${!apiResult.success ? `<p><strong>Erro:</strong> ${apiResult.error}</p>` : ''}
                </div>
            `;
        }

        function exportErrorLog() {
            const logData = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                diagnosticLog: diagnosticLog,
                systemInfo: {
                    online: navigator.onLine,
                    language: navigator.language,
                    platform: navigator.platform,
                    cookieEnabled: navigator.cookieEnabled
                },
                apiConfig: API_CONFIG
            };
            
            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostico-erp-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('üìÅ Log exportado com sucesso!', 'success');
        }

        // Inicializa√ß√£o
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        // Auto-teste inicial ap√≥s 2 segundos
        setTimeout(() => {
            log('üîÑ Executando teste autom√°tico inicial...', 'info');
            runCompleteTest();
        }, 2000);
    </script>
</body>
</html>