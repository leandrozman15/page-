<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Corre√ß√£o Failed to Fetch - Abratecnica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #dc3545 0%, #6c757d 100%);
            color: white;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .alert {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .alert-danger {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.2);
        }

        .alert-success {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
        }

        .alert-warning {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.2);
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .diagnostic-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 1rem;
        }

        .status-unknown { background: #6c757d; }
        .status-error { background: #dc3545; }
        .status-success { background: #28a745; }
        .status-warning { background: #ffc107; }

        .log-container {
            background: rgba(0,0,0,0.8);
            border-radius: 8px;
            padding: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }

        .url-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            margin: 1rem 0;
        }

        .url-input:focus {
            outline: none;
            border-color: #007bff;
            background: rgba(255,255,255,0.2);
        }

        .url-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s ease;
            width: 0%;
        }

        .code-block {
            background: rgba(0,0,0,0.6);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Corre√ß√£o Failed to Fetch</h1>
            <p>Diagn√≥stico e Corre√ß√£o Autom√°tica de Problemas de Conex√£o</p>
        </div>

        <!-- Status Atual -->
        <div class="alert alert-danger" id="statusAlert">
            <h3><span class="status-indicator status-error"></span>Problema Detectado</h3>
            <p><strong>Erro:</strong> Failed to fetch</p>
            <p><strong>Causa:</strong> Problemas com arrays, IDs ou conectividade</p>
            <p><strong>Status:</strong> <span id="currentStatus">Diagnosticando...</span></p>
        </div>

        <!-- Configura√ß√£o de URL -->
        <div class="diagnostic-card">
            <h3>‚öôÔ∏è Configura√ß√£o da API</h3>
            <label for="apiUrl">URL da API Firebase:</label>
            <input type="text" id="apiUrl" class="url-input" 
                   value="https://studio--firebase-explorer-7hc2p.us-central1.hosted.app"
                   placeholder="Cole a URL da sua API Firebase aqui">
            
            <button class="btn btn-primary" onclick="updateApiUrl()">
                üíæ Salvar URL
            </button>
            <button class="btn btn-warning" onclick="resetApiUrl()">
                üîÑ Resetar
            </button>
        </div>

        <!-- Testes de Corre√ß√£o -->
        <div class="diagnostic-grid">
            <div class="diagnostic-card">
                <h3>üîç Diagn√≥stico Autom√°tico</h3>
                <p>Executa uma s√©rie de testes para identificar o problema.</p>
                <button class="btn btn-primary" onclick="runFullDiagnostic()">
                    üöÄ Executar Diagn√≥stico
                </button>
                <div class="progress-bar">
                    <div class="progress-fill" id="diagnosticProgress"></div>
                </div>
            </div>

            <div class="diagnostic-card">
                <h3>üîß Corre√ß√£o Autom√°tica</h3>
                <p>Aplica corre√ß√µes conhecidas para o problema "Failed to fetch".</p>
                <button class="btn btn-success" onclick="applyFixes()">
                    ‚úÖ Aplicar Corre√ß√µes
                </button>
                <button class="btn btn-warning" onclick="testConnection()">
                    üß™ Testar Conex√£o
                </button>
            </div>

            <div class="diagnostic-card">
                <h3>üõí Teste de Or√ßamento</h3>
                <p>Testa a cria√ß√£o de um or√ßamento completo.</p>
                <button class="btn btn-success" onclick="testOrderCreation()">
                    üìã Testar Or√ßamento
                </button>
                <button class="btn btn-primary" onclick="testArrayHandling()">
                    üìä Testar Arrays
                </button>
            </div>

            <div class="diagnostic-card">
                <h3>üì± Teste de Produtos</h3>
                <p>Verifica o carregamento e agrupamento de produtos.</p>
                <button class="btn btn-primary" onclick="testProducts()">
                    üì¶ Testar Produtos
                </button>
                <button class="btn btn-warning" onclick="testProductIds()">
                    üÜî Testar IDs
                </button>
            </div>
        </div>

        <!-- Logs em Tempo Real -->
        <div class="alert">
            <h3>üìù Logs de Diagn√≥stico</h3>
            <div class="log-container" id="diagnosticLogs">
                <div style="color: #28a745;">[INFO] Sistema de corre√ß√£o inicializado</div>
                <div style="color: #ffc107;">[WARN] Aguardando execu√ß√£o de testes...</div>
            </div>
        </div>

        <!-- Resultado Final -->
        <div class="alert alert-warning" id="resultAlert" style="display: none;">
            <h3>üìä Resultado do Diagn√≥stico</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="failed-to-fetch-fix.js"></script>

    <script>
        class FailedToFetchDiagnostic {
            constructor() {
                this.apiUrl = 'https://studio--firebase-explorer-7hc2p.us-central1.hosted.app';
                this.diagnosticProgress = 0;
                this.testResults = [];
                
                this.initialize();
            }

            initialize() {
                this.log('üîß Sistema de corre√ß√£o "Failed to Fetch" inicializado');
                this.loadSavedUrl();
                this.updateStatus('Aguardando diagn√≥stico');
            }

            loadSavedUrl() {
                const saved = localStorage.getItem('firebase_api_url');
                if (saved) {
                    this.apiUrl = saved;
                    document.getElementById('apiUrl').value = saved;
                    this.log(`üìÇ URL carregada: ${saved}`);
                }
            }

            updateApiUrl() {
                const newUrl = document.getElementById('apiUrl').value.trim();
                if (!newUrl) {
                    this.log('‚ùå URL n√£o pode estar vazia', 'error');
                    return;
                }

                this.apiUrl = newUrl;
                localStorage.setItem('firebase_api_url', newUrl);
                this.log(`üíæ URL salva: ${newUrl}`, 'success');
                
                // Atualizar inst√¢ncia do Firebase ERP se existir
                if (window.firebaseERP) {
                    window.firebaseERP.config.BASE_URL = newUrl;
                    this.log('üîÑ Inst√¢ncia do Firebase ERP atualizada', 'info');
                }
            }

            resetApiUrl() {
                const defaultUrl = 'https://studio--firebase-explorer-7hc2p.us-central1.hosted.app';
                this.apiUrl = defaultUrl;
                document.getElementById('apiUrl').value = defaultUrl;
                localStorage.removeItem('firebase_api_url');
                this.log('üîÑ URL resetada para padr√£o', 'info');
            }

            async runFullDiagnostic() {
                this.log('üöÄ Iniciando diagn√≥stico completo...');
                this.testResults = [];
                this.diagnosticProgress = 0;
                this.updateProgress(0);

                const tests = [
                    { name: 'Conectividade B√°sica', fn: this.testBasicConnectivity },
                    { name: 'Inicializa√ß√£o do Sistema', fn: this.testSystemInitialization },
                    { name: 'Endpoints da API', fn: this.testApiEndpoints },
                    { name: 'Tratamento de Arrays', fn: this.testArrayHandling },
                    { name: 'Valida√ß√£o de IDs', fn: this.testIdValidation },
                    { name: 'Cria√ß√£o de Or√ßamento', fn: this.testOrderCreation },
                    { name: 'Carregamento de Produtos', fn: this.testProducts }
                ];

                for (let i = 0; i < tests.length; i++) {
                    const test = tests[i];
                    this.log(`üîç Executando: ${test.name}...`);
                    
                    try {
                        const result = await test.fn.call(this);
                        this.testResults.push({ name: test.name, status: 'success', result });
                        this.log(`‚úÖ ${test.name}: OK`, 'success');
                    } catch (error) {
                        this.testResults.push({ name: test.name, status: 'error', error: error.message });
                        this.log(`‚ùå ${test.name}: ${error.message}`, 'error');
                    }
                    
                    this.diagnosticProgress = ((i + 1) / tests.length) * 100;
                    this.updateProgress(this.diagnosticProgress);
                    
                    await this.sleep(500);
                }

                this.showFinalResult();
            }

            async testBasicConnectivity() {
                this.log('üåê Testando conectividade b√°sica...');
                
                try {
                    const controller = new AbortController();
                    setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(this.apiUrl, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        signal: controller.signal
                    });
                    
                    return 'Conectividade b√°sica OK';
                } catch (error) {
                    throw new Error(`Falha na conectividade: ${error.message}`);
                }
            }

            async testSystemInitialization() {
                this.log('üîß Testando inicializa√ß√£o do sistema...');
                
                if (!window.firebaseERP) {
                    throw new Error('Firebase ERP n√£o inicializado');
                }
                
                if (!window.firebaseERP.isInitialized) {
                    // Tentar inicializar
                    await window.firebaseERP.initializeSystem();
                }
                
                if (window.firebaseERP.connectionStatus === 'error') {
                    throw new Error('Sistema com status de erro');
                }
                
                return 'Sistema inicializado corretamente';
            }

            async testApiEndpoints() {
                this.log('üì° Testando endpoints da API...');
                
                const endpoints = ['/api/status', '/api/products'];
                const results = [];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await window.firebaseERP.makeRequest(endpoint);
                        results.push(`${endpoint}: OK`);
                    } catch (error) {
                        results.push(`${endpoint}: ERRO - ${error.message}`);
                    }
                }
                
                return results.join(', ');
            }

            async testArrayHandling() {
                this.log('üìä Testando tratamento de arrays...');
                
                // Simular resposta em array
                const mockArrayResponse = [{ success: true, test: 'array handling' }];
                const mockObjectResponse = { success: true, test: 'object handling' };
                
                // Testar extra√ß√£o de dados
                const arrayResult = Array.isArray(mockArrayResponse) ? mockArrayResponse[0] : mockArrayResponse;
                const objectResult = Array.isArray(mockObjectResponse) ? mockObjectResponse[0] : mockObjectResponse;
                
                if (!arrayResult.success || !objectResult.success) {
                    throw new Error('Falha no tratamento de arrays/objetos');
                }
                
                return 'Tratamento de arrays/objetos funcionando';
            }

            async testIdValidation() {
                this.log('üÜî Testando valida√ß√£o de IDs...');
                
                const testIds = ['produto-1', 'produto-var1', null, undefined, ''];
                const validIds = [];
                
                testIds.forEach(id => {
                    const processedId = String(id || 'unknown_' + Math.random());
                    if (processedId && processedId !== 'null' && processedId !== 'undefined') {
                        validIds.push(processedId);
                    }
                });
                
                if (validIds.length !== testIds.length) {
                    throw new Error('Alguns IDs n√£o foram processados corretamente');
                }
                
                return `${validIds.length} IDs processados corretamente`;
            }

            async testOrderCreation() {
                this.log('üõí Testando cria√ß√£o de or√ßamento...');
                
                if (!window.firebaseERP) {
                    throw new Error('Firebase ERP n√£o dispon√≠vel');
                }
                
                const testOrder = {
                    customerName: 'Teste Diagn√≥stico',
                    customerEmail: 'diagnostico@abratecnica.com.br',
                    items: [
                        {
                            id: 'test-product-1',
                            quantity: 1,
                            price: 100.00,
                            name: 'Produto de Teste'
                        }
                    ]
                };
                
                try {
                    const result = await window.firebaseERP.sendOrder(testOrder);
                    return `Or√ßamento criado: ${result.orderNumber}`;
                } catch (error) {
                    throw new Error(`Falha na cria√ß√£o: ${error.message}`);
                }
            }

            async testProducts() {
                this.log('üì¶ Testando carregamento de produtos...');
                
                if (!window.firebaseERP) {
                    throw new Error('Firebase ERP n√£o dispon√≠vel');
                }
                
                try {
                    const products = await window.firebaseERP.getProducts();
                    return `${products.total} produtos carregados`;
                } catch (error) {
                    throw new Error(`Falha no carregamento: ${error.message}`);
                }
            }

            async applyFixes() {
                this.log('üîß Aplicando corre√ß√µes autom√°ticas...');
                
                // Corre√ß√£o 1: Recriar inst√¢ncia do Firebase ERP
                this.log('üîÑ Recriando inst√¢ncia do Firebase ERP...');
                if (window.firebaseERP) {
                    delete window.firebaseERP;
                }
                window.firebaseERP = new FirebaseERPManagerFixed();
                
                // Corre√ß√£o 2: Configurar URL
                if (this.apiUrl) {
                    window.firebaseERP.config.BASE_URL = this.apiUrl;
                    this.log(`üåê URL configurada: ${this.apiUrl}`);
                }
                
                // Corre√ß√£o 3: For√ßar inicializa√ß√£o
                await window.firebaseERP.initializeSystem();
                this.log('‚úÖ Sistema reinicializado');
                
                // Corre√ß√£o 4: Testar conex√£o
                try {
                    const result = await window.firebaseERP.checkConnection();
                    if (result.status === 'healthy') {
                        this.updateStatus('Sistema corrigido e funcionando', 'success');
                        this.log('‚úÖ Todas as corre√ß√µes aplicadas com sucesso!', 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    this.updateStatus('Corre√ß√µes aplicadas mas ainda h√° problemas', 'warning');
                    this.log(`‚ö†Ô∏è Corre√ß√µes parciais: ${error.message}`, 'warning');
                }
            }

            async testConnection() {
                this.log('üß™ Testando conex√£o manual...');
                
                if (!window.firebaseERP) {
                    this.log('‚ùå Firebase ERP n√£o inicializado', 'error');
                    return;
                }
                
                try {
                    const result = await window.firebaseERP.checkConnection();
                    
                    if (result.status === 'healthy') {
                        this.updateStatus('Conex√£o OK', 'success');
                        this.log('‚úÖ Conex√£o funcionando perfeitamente!', 'success');
                        alert('‚úÖ Conex√£o OK!\n\nStatus: ' + result.status + '\nURL: ' + result.url);
                    } else {
                        this.updateStatus('Problema na conex√£o', 'error');
                        this.log(`‚ùå Problema: ${result.error}`, 'error');
                        alert('‚ùå Problema na conex√£o:\n\n' + result.error);
                    }
                } catch (error) {
                    this.updateStatus('Erro na conex√£o', 'error');
                    this.log(`‚ùå Erro: ${error.message}`, 'error');
                    alert('‚ùå Erro: ' + error.message);
                }
            }

            showFinalResult() {
                const successTests = this.testResults.filter(t => t.status === 'success');
                const errorTests = this.testResults.filter(t => t.status === 'error');
                
                const resultDiv = document.getElementById('resultAlert');
                const contentDiv = document.getElementById('resultContent');
                
                let html = `<h4>üìä Resumo do Diagn√≥stico</h4>`;
                html += `<p><strong>Total de testes:</strong> ${this.testResults.length}</p>`;
                html += `<p><strong>Sucessos:</strong> ${successTests.length}</p>`;
                html += `<p><strong>Falhas:</strong> ${errorTests.length}</p>`;
                
                if (errorTests.length === 0) {
                    resultDiv.className = 'alert alert-success';
                    html += `<p style="color: #28a745;"><strong>‚úÖ Todos os testes passaram! Sistema funcionando.</strong></p>`;
                    this.updateStatus('Sistema funcionando', 'success');
                } else {
                    resultDiv.className = 'alert alert-danger';
                    html += `<p style="color: #dc3545;"><strong>‚ùå Problemas encontrados:</strong></p>`;
                    html += `<ul>`;
                    errorTests.forEach(test => {
                        html += `<li>${test.name}: ${test.error}</li>`;
                    });
                    html += `</ul>`;
                    this.updateStatus('Problemas encontrados', 'error');
                }
                
                contentDiv.innerHTML = html;
                resultDiv.style.display = 'block';
                
                this.log('üìä Diagn√≥stico conclu√≠do');
            }

            updateStatus(status, type = 'info') {
                const statusEl = document.getElementById('currentStatus');
                const alertEl = document.getElementById('statusAlert');
                
                statusEl.textContent = status;
                
                if (type === 'success') {
                    alertEl.className = 'alert alert-success';
                } else if (type === 'warning') {
                    alertEl.className = 'alert alert-warning';
                } else if (type === 'error') {
                    alertEl.className = 'alert alert-danger';
                }
            }

            updateProgress(percentage) {
                document.getElementById('diagnosticProgress').style.width = `${percentage}%`;
            }

            log(message, type = 'info') {
                const container = document.getElementById('diagnosticLogs');
                const timestamp = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                
                let color = '#e2e8f0';
                if (type === 'error') color = '#dc3545';
                else if (type === 'success') color = '#28a745';
                else if (type === 'warning') color = '#ffc107';
                
                entry.style.color = color;
                entry.textContent = `[${timestamp}] ${message}`;
                
                container.appendChild(entry);
                container.scrollTop = container.scrollHeight;
                
                // Limitar logs
                while (container.children.length > 50) {
                    container.removeChild(container.firstChild);
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Fun√ß√µes globais
        let diagnostic;

        function updateApiUrl() { diagnostic.updateApiUrl(); }
        function resetApiUrl() { diagnostic.resetApiUrl(); }
        function runFullDiagnostic() { diagnostic.runFullDiagnostic(); }
        function applyFixes() { diagnostic.applyFixes(); }
        function testConnection() { diagnostic.testConnection(); }
        function testOrderCreation() { diagnostic.testOrderCreation(); }
        function testArrayHandling() { diagnostic.testArrayHandling(); }
        function testProducts() { diagnostic.testProducts(); }
        function testProductIds() { diagnostic.testIdValidation(); }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            diagnostic = new FailedToFetchDiagnostic();
        });
    </script>
</body>
</html>