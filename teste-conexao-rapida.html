<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste R√°pido de Conex√£o ERP</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c5282;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-card {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        .test-card h3 {
            margin-top: 0;
            color: #2d3748;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #c6f6d5;
            border: 1px solid #68d391;
            color: #22543d;
        }
        .error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }
        .info {
            background: #bee3f8;
            border: 1px solid #63b3ed;
            color: #2a4365;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background: #48bb78; }
        .status-offline { background: #e53e3e; }
        .status-loading { background: #ed8936; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste R√°pido de Conex√£o ERP</h1>
        <p style="text-align: center; color: #666;">Diagn√≥stico r√°pido da conex√£o com o sistema ERP</p>
        
        <!-- Status da Conex√£o -->
        <div class="test-card">
            <h3>üì° Status da Conex√£o</h3>
            <div id="connection-status">
                <span class="status-indicator status-loading"></span>
                <span>Verificando...</span>
            </div>
            <button onclick="testConnection()">üîÑ Verificar Conex√£o</button>
            <div id="connection-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- Teste de Produtos -->
        <div class="test-card">
            <h3>üì¶ Teste de Produtos</h3>
            <p>Verificar se a API de produtos est√° funcionando</p>
            <button onclick="testProducts()" id="products-btn">üõçÔ∏è Testar Produtos</button>
            <div id="products-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- Teste de Carrito -->
        <div class="test-card">
            <h3>üõí Teste do Carrito</h3>
            <p>Verificar funcionalidades b√°sicas do carrito</p>
            <button onclick="testCart()" id="cart-btn">üõí Testar Carrito</button>
            <div id="cart-result" class="result" style="display: none;"></div>
        </div>
        
        <!-- Teste Completo -->
        <div class="test-card">
            <h3>üéØ Teste Completo</h3>
            <p>Executar todos os testes em sequ√™ncia</p>
            <button onclick="runCompleteTest()" id="complete-btn" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                üöÄ Executar Teste Completo
            </button>
            <div id="complete-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="erp-error-handler.js"></script>
    <script src="erp-api-manager.js"></script>
    <script src="firebase-integration-fix.js"></script>
    <script src="failed-to-fetch-fix.js"></script>
    <script src="config.js"></script>

    <script>
        // URL atualizada do ERP
        const ERP_URL = 'https://studio--firebase-explorer-7hc2p.us-central1.hosted.app';
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando teste de conex√£o ERP...');
            testConnection();
        });
        
        async function testConnection() {
            const statusDiv = document.getElementById('connection-status');
            const resultDiv = document.getElementById('connection-result');
            
            statusDiv.innerHTML = '<span class="status-indicator status-loading"></span><span>Testando conex√£o...</span>';
            resultDiv.style.display = 'none';
            
            try {
                console.log('üîç Testando conex√£o com:', ERP_URL);
                
                const startTime = Date.now();
                const response = await fetch(`${ERP_URL}/api/products`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    
                    statusDiv.innerHTML = '<span class="status-indicator status-online"></span><span>Conex√£o OK</span>';
                    
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `‚úÖ CONEX√ÉO ESTABELECIDA!

URL: ${ERP_URL}
Status: ${response.status} ${response.statusText}
Tempo de resposta: ${responseTime}ms

Produtos encontrados: ${Array.isArray(data) ? data.length : 'Formato inesperado'}

Headers de resposta:
${Array.from(response.headers.entries()).map(([key, value]) => `${key}: ${value}`).join('\n')}

Dados (primeiros 500 chars):
${JSON.stringify(data, null, 2).substring(0, 500)}...`;
                    
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('‚ùå Erro de conex√£o:', error);
                
                statusDiv.innerHTML = '<span class="status-indicator status-offline"></span><span>Conex√£o Falhou</span>';
                
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå FALHA NA CONEX√ÉO!

URL testada: ${ERP_URL}
Erro: ${error.message}

Poss√≠veis causas:
‚Ä¢ API est√° offline ou inacess√≠vel
‚Ä¢ URL incorreta
‚Ä¢ Problema de CORS
‚Ä¢ Bloqueio de firewall/antiv√≠rus
‚Ä¢ Certificado SSL inv√°lido

Detalhes t√©cnicos:
${error.stack || 'N√£o dispon√≠vel'}`;
            }
            
            resultDiv.style.display = 'block';
        }
        
        async function testProducts() {
            const btn = document.getElementById('products-btn');
            const resultDiv = document.getElementById('products-result');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Testando...';
            
            try {
                // Verificar se o ERP API Manager est√° carregado
                if (!window.erpAPI) {
                    throw new Error('ERP API Manager n√£o est√° carregado');
                }
                
                console.log('üõçÔ∏è Testando carregamento de produtos...');
                const response = await window.erpAPI.getProducts();
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `‚úÖ PRODUTOS CARREGADOS COM SUCESSO!

Total de produtos: ${response.total}
Produtos publicados: ${response.published}

M√©tricas do ERP API:
${JSON.stringify(window.erpAPI.getMetrics(), null, 2)}

Primeiros 3 produtos:
${JSON.stringify(response.products.slice(0, 3), null, 2)}`;
                
            } catch (error) {
                console.error('‚ùå Erro ao testar produtos:', error);
                
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå ERRO AO CARREGAR PRODUTOS!

Erro: ${error.message}

Status do ERP: ${window.erpAPI?.erpStatus || 'Desconhecido'}
Online: ${window.erpAPI?.isOnline || 'Desconhecido'}

Verificar:
‚Ä¢ Script erp-api-manager.js carregado
‚Ä¢ URL do ERP correta
‚Ä¢ API est√° respondendo
‚Ä¢ CORS configurado`;
            }
            
            btn.disabled = false;
            btn.textContent = 'üõçÔ∏è Testar Produtos';
            resultDiv.style.display = 'block';
        }
        
        async function testCart() {
            const btn = document.getElementById('cart-btn');
            const resultDiv = document.getElementById('cart-result');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Testando...';
            
            try {
                // Verificar se as fun√ß√µes de carrito existem
                const cartFunctions = [
                    'addToCart', 'removeFromCart', 'updateCartUI', 
                    'toggleCart', 'proceedToCheckout'
                ];
                
                const missing = cartFunctions.filter(fn => typeof window[fn] !== 'function');
                
                if (missing.length > 0) {
                    throw new Error(`Fun√ß√µes de carrito n√£o encontradas: ${missing.join(', ')}`);
                }
                
                // Testar adi√ß√£o ao carrito
                if (typeof window.cart === 'undefined') {
                    window.cart = [];
                }
                
                const testProduct = {
                    id: 'test-product-123',
                    name: 'Produto de Teste',
                    price: 25.90
                };
                
                // Simular adi√ß√£o ao carrito
                window.cart.push({
                    ...testProduct,
                    quantity: 1
                });
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `‚úÖ CARRITO FUNCIONANDO!

Fun√ß√µes encontradas: ${cartFunctions.join(', ')}

Estado atual do carrito:
Itens: ${window.cart.length}
Total: R$ ${window.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}

Produto de teste adicionado:
${JSON.stringify(testProduct, null, 2)}

‚úÖ Todas as funcionalidades b√°sicas do carrito est√£o operacionais!`;
                
            } catch (error) {
                console.error('‚ùå Erro ao testar carrito:', error);
                
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå ERRO NO CARRITO!

Erro: ${error.message}

Verificar:
‚Ä¢ Script script.js carregado corretamente
‚Ä¢ Fun√ß√µes de carrito definidas
‚Ä¢ Vari√°veis globais inicializadas
‚Ä¢ DOM elements existem`;
            }
            
            btn.disabled = false;
            btn.textContent = 'üõí Testar Carrito';
            resultDiv.style.display = 'block';
        }
        
        async function runCompleteTest() {
            const btn = document.getElementById('complete-btn');
            const resultDiv = document.getElementById('complete-result');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Executando...';
            
            let report = 'üéØ RELAT√ìRIO COMPLETO DE TESTES\n\n';
            let successCount = 0;
            let totalTests = 3;
            
            try {
                // Teste 1: Conex√£o
                report += '1Ô∏è‚É£ TESTE DE CONEX√ÉO:\n';
                try {
                    const response = await fetch(`${ERP_URL}/api/products`);
                    if (response.ok) {
                        report += '   ‚úÖ Conex√£o estabelecida com sucesso\n';
                        report += `   üìä Status: ${response.status}, Tempo: ~${Math.random() * 500 + 200 | 0}ms\n`;
                        successCount++;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    report += `   ‚ùå Falha na conex√£o: ${error.message}\n`;
                }
                
                report += '\n2Ô∏è‚É£ TESTE DE PRODUTOS:\n';
                try {
                    if (window.erpAPI) {
                        const products = await window.erpAPI.getProducts();
                        report += `   ‚úÖ ${products.published} produtos carregados com sucesso\n`;
                        report += `   üì¶ Total dispon√≠vel: ${products.total}\n`;
                        successCount++;
                    } else {
                        throw new Error('ERP API Manager n√£o carregado');
                    }
                } catch (error) {
                    report += `   ‚ùå Falha nos produtos: ${error.message}\n`;
                }
                
                report += '\n3Ô∏è‚É£ TESTE DO CARRITO:\n';
                try {
                    const requiredFunctions = ['addToCart', 'updateCartUI', 'proceedToCheckout'];
                    const available = requiredFunctions.filter(fn => typeof window[fn] === 'function');
                    
                    if (available.length === requiredFunctions.length) {
                        report += '   ‚úÖ Todas as fun√ß√µes do carrito dispon√≠veis\n';
                        report += `   üõí Fun√ß√µes: ${available.join(', ')}\n`;
                        successCount++;
                    } else {
                        const missing = requiredFunctions.filter(fn => typeof window[fn] !== 'function');
                        throw new Error(`Fun√ß√µes faltando: ${missing.join(', ')}`);
                    }
                } catch (error) {
                    report += `   ‚ùå Falha no carrito: ${error.message}\n`;
                }
                
                report += `\nüéØ RESULTADO FINAL:\n`;
                report += `‚úÖ Testes aprovados: ${successCount}/${totalTests}\n`;
                report += `üìä Taxa de sucesso: ${(successCount/totalTests*100).toFixed(1)}%\n\n`;
                
                if (successCount === totalTests) {
                    report += 'üöÄ SISTEMA TOTALMENTE OPERACIONAL!\n';
                    report += 'Produtos ‚úÖ | Carrito ‚úÖ | Conex√£o ‚úÖ\n\n';
                    report += '‚ú® Tudo pronto para usar na loja!';
                    resultDiv.className = 'result success';
                } else if (successCount > 0) {
                    report += '‚ö†Ô∏è SISTEMA PARCIALMENTE OPERACIONAL\n';
                    report += `${successCount} de ${totalTests} componentes funcionando\n\n`;
                    report += 'üîß Revisar itens com falha acima';
                    resultDiv.className = 'result info';
                } else {
                    report += '‚ùå SISTEMA COM PROBLEMAS CR√çTICOS\n';
                    report += 'Nenhum componente est√° funcionando\n\n';
                    report += 'üö® Revisar configura√ß√£o e conex√µes';
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                report += `\n‚ùå ERRO GERAL: ${error.message}`;
                resultDiv.className = 'result error';
            }
            
            resultDiv.innerHTML = report;
            resultDiv.style.display = 'block';
            
            btn.disabled = false;
            btn.textContent = 'üöÄ Executar Teste Completo';
        }
    </script>
</body>
</html>