<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico ERP - Productos y Carrito</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
            font-size: 14px;
            line-height: 1.4;
        }
        .terminal {
            background: #000;
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        .terminal h3 {
            color: #00ffff;
            margin-top: 0;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        .info { color: #00ffff; }
        .data { color: #ffffff; background: #333; padding: 5px; border-radius: 3px; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #00ffff;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="terminal">
        <h3>üîß DIAGN√ìSTICO COMPLETO - ERP & CARRITO</h3>
        <div class="log-entry info">Sistema iniciado √†s <span id="init-time"></span></div>
        <button onclick="runFullDiagnostic()">üöÄ EXECUTAR DIAGN√ìSTICO COMPLETO</button>
        <button onclick="clearLogs()">üóëÔ∏è LIMPAR LOGS</button>
        <button onclick="testDirectConnection()">üîó TESTE DIRETO ERP</button>
    </div>

    <div class="status-grid">
        <!-- Status dos Scripts -->
        <div class="terminal">
            <h3>üìú STATUS DOS SCRIPTS</h3>
            <div id="scripts-status">Verificando...</div>
        </div>

        <!-- Status da API -->
        <div class="terminal">
            <h3>üåê STATUS DA API</h3>
            <div id="api-status">Verificando...</div>
        </div>

        <!-- Status do Carrito -->
        <div class="terminal">
            <h3>üõí STATUS DO CARRITO</h3>
            <div id="cart-status">Verificando...</div>
        </div>

        <!-- Logs em Tempo Real -->
        <div class="terminal">
            <h3>üìã LOGS EM TEMPO REAL</h3>
            <div id="realtime-logs" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Teste de Produtos -->
    <div class="terminal">
        <h3>üì¶ TESTE DE PRODUTOS</h3>
        <button onclick="testProductsLoad()">üîÑ CARREGAR PRODUTOS</button>
        <button onclick="testSingleProduct()">üîç TESTE PRODUTO INDIVIDUAL</button>
        <div id="products-test-result"></div>
    </div>

    <!-- Scripts -->
    <script src="erp-error-handler.js"></script>
    <script src="erp-api-manager.js"></script>
    <script src="firebase-integration-fix.js"></script>
    <script src="failed-to-fetch-fix.js"></script>
    <script src="security-config.js"></script>
    <script src="config.js"></script>
    <script src="script.js"></script>

    <script>
        // Variables globales
        let diagnosticLogs = [];
        let testCart = [];
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('init-time').textContent = new Date().toLocaleString();
            log('üöÄ Sistema de diagn√≥stico iniciado', 'info');
            
            // Ejecutar diagn√≥stico autom√°tico despu√©s de 2 segundos
            setTimeout(() => {
                runFullDiagnostic();
            }, 2000);
        });
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            diagnosticLogs.push({ timestamp, message, type });
            
            const logsDiv = document.getElementById('realtime-logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${type}`;
            logDiv.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function clearLogs() {
            diagnosticLogs = [];
            document.getElementById('realtime-logs').innerHTML = '';
            log('üóëÔ∏è Logs limpiados', 'info');
        }
        
        async function runFullDiagnostic() {
            log('üîç Iniciando diagn√≥stico completo...', 'info');
            
            // 1. Verificar scripts carregados
            checkScriptsStatus();
            
            // 2. Verificar API status
            await checkAPIStatus();
            
            // 3. Verificar funciones del carrito
            checkCartStatus();
            
            // 4. Teste de conectividad
            await testDirectConnection();
            
            log('‚úÖ Diagn√≥stico completo finalizado', 'success');
        }
        
        function checkScriptsStatus() {
            log('üìú Verificando status dos scripts...', 'info');
            
            const scripts = [
                { name: 'erpAPI', object: window.erpAPI, critical: true },
                { name: 'erpErrorHandler', object: window.erpErrorHandler, critical: true },
                { name: 'FirebaseERPManager', object: window.FirebaseERPManager, critical: false },
                { name: 'CONFIG', object: window.CONFIG, critical: false },
                { name: 'cart (variable)', object: window.cart, critical: true },
                { name: 'loadShopProducts (function)', object: window.loadShopProducts, critical: true },
                { name: 'addToCart (function)', object: window.addToCart, critical: true }
            ];
            
            let scriptsHTML = '';
            let loadedCount = 0;
            let criticalCount = 0;
            let criticalLoaded = 0;
            
            scripts.forEach(script => {
                const loaded = script.object !== undefined && script.object !== null;
                const status = loaded ? '‚úÖ' : '‚ùå';
                const className = loaded ? 'success' : 'error';
                
                if (loaded) loadedCount++;
                if (script.critical) {
                    criticalCount++;
                    if (loaded) criticalLoaded++;
                }
                
                scriptsHTML += `<div class="log-entry ${className}">${status} ${script.name} ${script.critical ? '(CR√çTICO)' : ''}</div>`;
                log(`${status} Script: ${script.name} ${loaded ? 'CARREGADO' : 'FALTANDO'}`, loaded ? 'success' : 'error');
            });
            
            scriptsHTML += `<div class="log-entry info">üìä Total: ${loadedCount}/${scripts.length} | Cr√≠ticos: ${criticalLoaded}/${criticalCount}</div>`;
            document.getElementById('scripts-status').innerHTML = scriptsHTML;
            
            if (criticalLoaded < criticalCount) {
                log(`‚ö†Ô∏è ATEN√á√ÉO: ${criticalCount - criticalLoaded} scripts cr√≠ticos faltando!`, 'error');
            }
        }
        
        async function checkAPIStatus() {
            log('üåê Verificando status da API...', 'info');
            
            let apiHTML = '';
            
            try {
                // Verificar se erpAPI existe
                if (!window.erpAPI) {
                    throw new Error('erpAPI n√£o est√° carregado');
                }
                
                // Verificar configura√ß√£o
                const config = window.erpAPI.config;
                apiHTML += `<div class="log-entry info">üì° URL Base: ${config.BASE_URL}</div>`;
                apiHTML += `<div class="log-entry info">üîó Endpoint Produtos: ${config.ENDPOINTS.PRODUCTS}</div>`;
                
                // Testar conectividade
                log('üîç Testando conectividade com ERP...', 'info');
                const response = await window.erpAPI.getProducts();
                
                if (response && response.products) {
                    apiHTML += `<div class="log-entry success">‚úÖ API Respondendo</div>`;
                    apiHTML += `<div class="log-entry success">üì¶ ${response.total} produtos total</div>`;
                    apiHTML += `<div class="log-entry success">üìã ${response.published} produtos publicados</div>`;
                    
                    log(`‚úÖ API funcionando: ${response.published} produtos dispon√≠veis`, 'success');
                } else {
                    throw new Error('Resposta inv√°lida da API');
                }
                
                // Verificar m√©tricas
                const metrics = window.erpAPI.getMetrics();
                apiHTML += `<div class="log-entry info">üìä Requests: ${metrics.requests}</div>`;
                apiHTML += `<div class="log-entry info">‚ö° Sucessos: ${metrics.successes}</div>`;
                apiHTML += `<div class="log-entry info">‚ùå Falhas: ${metrics.failures}</div>`;
                
            } catch (error) {
                apiHTML += `<div class="log-entry error">‚ùå Erro: ${error.message}</div>`;
                log(`‚ùå Erro na API: ${error.message}`, 'error');
                
                // Diagn√≥stico adicional
                if (error.message.includes('Failed to fetch')) {
                    apiHTML += `<div class="log-entry warning">‚ö†Ô∏è Poss√≠vel problema de CORS ou conectividade</div>`;
                } else if (error.message.includes('erpAPI n√£o est√° carregado')) {
                    apiHTML += `<div class="log-entry warning">‚ö†Ô∏è Script erp-api-manager.js n√£o carregou</div>`;
                }
            }
            
            document.getElementById('api-status').innerHTML = apiHTML;
        }
        
        function checkCartStatus() {
            log('üõí Verificando status do carrito...', 'info');
            
            const cartFunctions = [
                'addToCart', 'removeFromCart', 'updateCartUI', 
                'toggleCart', 'proceedToCheckout', 'clearCart'
            ];
            
            let cartHTML = '';
            let functionsCount = 0;
            
            cartFunctions.forEach(fn => {
                const exists = typeof window[fn] === 'function';
                const status = exists ? '‚úÖ' : '‚ùå';
                const className = exists ? 'success' : 'error';
                
                if (exists) functionsCount++;
                
                cartHTML += `<div class="log-entry ${className}">${status} ${fn}()</div>`;
                log(`${status} Fun√ß√£o: ${fn}()`, exists ? 'success' : 'error');
            });
            
            // Verificar vari√°vel do carrito
            const cartExists = Array.isArray(window.cart);
            cartHTML += `<div class="log-entry ${cartExists ? 'success' : 'error'}">${cartExists ? '‚úÖ' : '‚ùå'} Vari√°vel cart[]</div>`;
            
            if (cartExists) {
                cartHTML += `<div class="log-entry info">üìä Itens no carrito: ${window.cart.length}</div>`;
            }
            
            cartHTML += `<div class="log-entry info">üìä Fun√ß√µes: ${functionsCount}/${cartFunctions.length}</div>`;
            
            document.getElementById('cart-status').innerHTML = cartHTML;
            
            // Teste funcional do carrito
            if (functionsCount === cartFunctions.length && cartExists) {
                log('‚úÖ Carrito totalmente funcional', 'success');
            } else {
                log(`‚ö†Ô∏è Carrito com problemas: ${6 - functionsCount - (cartExists ? 0 : 1)} componentes faltando`, 'warning');
            }
        }
        
        async function testDirectConnection() {
            log('üîó Testando conex√£o direta com ERP...', 'info');
            
            const erpUrl = 'https://studio--firebase-explorer-7hc2p.us-central1.hosted.app';
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${erpUrl}/api/products`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Conex√£o direta OK em ${responseTime}ms`, 'success');
                    log(`üì¶ ${Array.isArray(data) ? data.length : 'N/A'} produtos retornados`, 'info');
                    
                    // Mostrar primeiro produto como exemplo
                    if (Array.isArray(data) && data.length > 0) {
                        const firstProduct = data[0];
                        log(`üîç Exemplo: ${firstProduct.name || 'Sem nome'} - R$ ${firstProduct.price || 0}`, 'data');
                    }
                    
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                log(`‚ùå Conex√£o direta falhou: ${error.message}`, 'error');
                
                // Diagn√≥stico de erro
                if (error.message.includes('Failed to fetch')) {
                    log('üîç Poss√≠veis causas: CORS, URL incorreta, API offline', 'warning');
                } else if (error.message.includes('CORS')) {
                    log('üîç Problema espec√≠fico de CORS', 'warning');
                }
            }
        }
        
        async function testProductsLoad() {
            log('üì¶ Testando carregamento de produtos...', 'info');
            
            const resultDiv = document.getElementById('products-test-result');
            resultDiv.innerHTML = '<div class="log-entry info">üîÑ Carregando...</div>';
            
            try {
                if (!window.erpAPI) {
                    throw new Error('erpAPI n√£o dispon√≠vel');
                }
                
                const response = await window.erpAPI.getProducts();
                
                let resultHTML = `<div class="log-entry success">‚úÖ Produtos carregados com sucesso!</div>`;
                resultHTML += `<div class="log-entry info">üìä Total: ${response.total}</div>`;
                resultHTML += `<div class="log-entry info">üìã Publicados: ${response.published}</div>`;
                
                // Mostrar alguns produtos
                if (response.products && response.products.length > 0) {
                    resultHTML += `<div class="log-entry data">üîç PRIMEIROS 3 PRODUTOS:</div>`;
                    response.products.slice(0, 3).forEach((product, index) => {
                        resultHTML += `<div class="log-entry data">${index + 1}. ${product.name || 'Sem nome'} - R$ ${(product.price || 0).toFixed(2)} - Stock: ${product.stock || 0}</div>`;
                    });
                }
                
                resultDiv.innerHTML = resultHTML;
                log(`‚úÖ Teste de produtos: ${response.published} produtos carregados`, 'success');
                
            } catch (error) {
                const errorHTML = `<div class="log-entry error">‚ùå Erro: ${error.message}</div>`;
                resultDiv.innerHTML = errorHTML;
                log(`‚ùå Teste de produtos falhou: ${error.message}`, 'error');
            }
        }
        
        async function testSingleProduct() {
            log('üîç Testando produto individual...', 'info');
            
            try {
                if (!window.erpAPI) {
                    throw new Error('erpAPI n√£o dispon√≠vel');
                }
                
                // Primeiro carregar todos os produtos
                const allProducts = await window.erpAPI.getProducts();
                
                if (!allProducts.products || allProducts.products.length === 0) {
                    throw new Error('Nenhum produto dispon√≠vel para teste');
                }
                
                // Pegar o primeiro produto
                const firstProduct = allProducts.products[0];
                log(`üîç Testando produto: ${firstProduct.name}`, 'info');
                
                // Testar adi√ß√£o ao carrito
                if (typeof window.addToCart === 'function') {
                    // Simular clique no bot√£o
                    window.addToCart(firstProduct.id, firstProduct.name, firstProduct.price);
                    log(`‚úÖ Produto adicionado ao carrito: ${firstProduct.name}`, 'success');
                    
                    // Verificar se foi adicionado
                    if (window.cart && window.cart.length > 0) {
                        const addedItem = window.cart.find(item => item.id === firstProduct.id);
                        if (addedItem) {
                            log(`‚úÖ Confirmado no carrito: ${addedItem.quantity}x ${addedItem.name}`, 'success');
                        } else {
                            log(`‚ö†Ô∏è Produto n√£o encontrado no carrito ap√≥s adi√ß√£o`, 'warning');
                        }
                    } else {
                        log(`‚ö†Ô∏è Carrito vazio ap√≥s adi√ß√£o`, 'warning');
                    }
                } else {
                    log(`‚ùå Fun√ß√£o addToCart n√£o dispon√≠vel`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Teste de produto individual falhou: ${error.message}`, 'error');
            }
        }
        
        // Verificar periodicamente o status
        setInterval(() => {
            // Log de status a cada 30 segundos
            const timestamp = new Date().toLocaleTimeString();
            if (window.erpAPI) {
                const metrics = window.erpAPI.getMetrics();
                log(`üìä [${timestamp}] Status: ${metrics.successes} sucessos, ${metrics.failures} falhas`, 'info');
            }
        }, 30000);
        
        // Interceptar erros globais
        window.addEventListener('error', function(event) {
            log(`‚ùå Erro global capturado: ${event.error?.message || event.message}`, 'error');
        });
        
        // Interceptar erros de promise rejeitadas  
        window.addEventListener('unhandledrejection', function(event) {
            log(`‚ùå Promise rejeitada: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>